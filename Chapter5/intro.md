# æ„å»ºä¸ªäººæ™ºèƒ½ä½“æ¡†æ¶

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®²è§£äº†æ™ºèƒ½ä½“çš„åŸºç¡€çŸ¥è¯†ï¼Œå¹¶ä½“éªŒäº†ä¸»æµæ¡†æ¶å¸¦æ¥çš„å¼€å‘ä¾¿åˆ©ã€‚ä»æœ¬ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥ä¸€ä¸ªæ›´å…·æŒ‘æˆ˜ä¹Ÿæ›´æœ‰ä»·å€¼çš„é˜¶æ®µï¼šä»é›¶å¼€å§‹ï¼Œé€æ­¥æ„å»ºä¸€ä¸ªæ™ºèƒ½ä½“æ¡†æ¶â€”â€”(Name)Agentã€‚

ä¸ºç¡®ä¿å­¦ä¹ è¿‡ç¨‹çš„è¿è´¯æ€§ä¸å¯å¤ç°æ€§ï¼Œä½ æ‰€å‘½åçš„ Agent å°†ä»¥ç‰ˆæœ¬è¿­ä»£çš„æ–¹å¼æ¨è¿›å¼€å‘ã€‚

## æ¡†æ¶æ•´ä½“æ¶æ„è®¾è®¡

### ä¸ºä½•éœ€è¦è‡ªå»º Agent æ¡†æ¶

åœ¨æ™ºèƒ½ä½“æŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œå¸‚é¢ä¸Šå·²ç»å­˜åœ¨ä¼—å¤šæˆç†Ÿçš„ Agent æ¡†æ¶ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜è¦ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªæ–°çš„æ¡†æ¶å‘¢ï¼Ÿ

#### 1. å¸‚é¢æ¡†æ¶çš„å¿«é€Ÿè¿­ä»£ä¸å±€é™æ€§

æ™ºèƒ½ä½“é¢†åŸŸæ˜¯ä¸€ä¸ªå¿«é€Ÿå‘å±•çš„é¢†åŸŸï¼Œéšæ—¶ä¼šæœ‰æ–°çš„æ¦‚å¿µäº§ç”Ÿï¼Œå¯¹äºæ™ºèƒ½ä½“çš„è®¾è®¡æ¯ä¸ªæ¡†æ¶éƒ½æœ‰è‡ªå·±çš„å®šä½å’Œç†è§£ï¼Œä¸è¿‡æ™ºèƒ½ä½“çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹æ˜¯ä¸€è‡´çš„ã€‚

- **è¿‡åº¦æŠ½è±¡çš„å¤æ‚æ€§**ï¼šè®¸å¤šæ¡†æ¶ä¸ºäº†è¿½æ±‚é€šç”¨æ€§ï¼Œå¼•å…¥äº†å¤§é‡æŠ½è±¡å±‚å’Œé…ç½®é€‰é¡¹ã€‚ä»¥ LangChain ä¸ºä¾‹ï¼Œå…¶é“¾å¼è°ƒç”¨æœºåˆ¶è™½ç„¶çµæ´»ï¼Œä½†å¯¹åˆå­¦è€…è€Œè¨€å­¦ä¹ æ›²çº¿é™¡å³­ï¼Œå¾€å¾€éœ€è¦ç†è§£å¤§é‡æ¦‚å¿µæ‰èƒ½å®Œæˆç®€å•ä»»åŠ¡ã€‚

- **å¿«é€Ÿè¿­ä»£å¸¦æ¥çš„ä¸ç¨³å®šæ€§**ï¼šå•†ä¸šåŒ–æ¡†æ¶ä¸ºäº†æŠ¢å å¸‚åœºï¼ŒAPI æ¥å£å˜æ›´é¢‘ç¹ã€‚å¼€å‘è€…ç»å¸¸é¢ä¸´ç‰ˆæœ¬å‡çº§åä»£ç æ— æ³•è¿è¡Œçš„å›°æ‰°ï¼Œç»´æŠ¤æˆæœ¬å±…é«˜ä¸ä¸‹ã€‚

- **é»‘ç›’åŒ–çš„å®ç°é€»è¾‘**ï¼šè®¸å¤šæ¡†æ¶å°†æ ¸å¿ƒé€»è¾‘å°è£…å¾—è¿‡äºä¸¥å¯†ï¼Œå¼€å‘è€…éš¾ä»¥ç†è§£ Agent çš„å†…éƒ¨å·¥ä½œæœºåˆ¶ï¼Œç¼ºä¹æ·±åº¦å®šåˆ¶èƒ½åŠ›ã€‚é‡åˆ°é—®é¢˜æ—¶åªèƒ½ä¾èµ–æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒï¼Œå°¤å…¶æ˜¯å¦‚æœç¤¾åŒºä¸å¤Ÿæ´»è·ƒï¼Œå¯èƒ½ä¸€ä¸ªåé¦ˆæ„è§ä¼šéå¸¸ä¹…ä¹Ÿæ²¡æœ‰äººæ¨è¿›ï¼Œå½±å“åç»­çš„å¼€å‘æ•ˆç‡ã€‚

- **ä¾èµ–å…³ç³»çš„å¤æ‚æ€§**ï¼šæˆç†Ÿæ¡†æ¶å¾€å¾€æºå¸¦å¤§é‡ä¾èµ–åŒ…ï¼Œå®‰è£…åŒ…ä½“ç§¯åºå¤§ï¼Œåœ¨éœ€è¦ä¸åˆ«çš„é¡¹ç›®ä»£ç é…åˆçš„æƒ…å†µä¸‹å¯èƒ½å‡ºç°ä¾èµ–å†²çªé—®é¢˜ã€‚

#### 2. ä»ä½¿ç”¨è€…åˆ°æ„å»ºè€…çš„èƒ½åŠ›è·ƒè¿

æ„å»ºè‡ªå·±çš„ Agent æ¡†æ¶ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªä»"ä½¿ç”¨è€…"å‘"æ„å»ºè€…"è½¬å˜çš„è¿‡ç¨‹ã€‚è¿™ç§è½¬å˜å¸¦æ¥çš„ä»·å€¼æ˜¯é•¿è¿œçš„ã€‚

- **æ·±åº¦ç†è§£ Agent å·¥ä½œåŸç†**ï¼šé€šè¿‡äº²æ‰‹å®ç°æ¯ä¸ªç»„ä»¶ï¼Œå¼€å‘è€…èƒ½å¤ŸçœŸæ­£ç†è§£ Agent çš„æ€è€ƒè¿‡ç¨‹ã€å·¥å…·è°ƒç”¨æœºåˆ¶ã€ä»¥åŠå„ç§è®¾è®¡æ¨¡å¼çš„å¥½åä¸åŒºåˆ«ã€‚

- **è·å¾—å®Œå…¨çš„æ§åˆ¶æƒ**ï¼šè‡ªå»ºæ¡†æ¶æ„å‘³ç€å¯¹æ¯ä¸€è¡Œä»£ç éƒ½æœ‰å®Œå…¨çš„æŒæ§ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è¿›è¡Œç²¾ç¡®è°ƒä¼˜ï¼Œè€Œä¸å—ç¬¬ä¸‰æ–¹æ¡†æ¶è®¾è®¡ç†å¿µçš„æŸç¼šã€‚

- **åŸ¹å…»ç³»ç»Ÿè®¾è®¡èƒ½åŠ›**ï¼šæ¡†æ¶æ„å»ºè¿‡ç¨‹æ¶‰åŠæ¨¡å—åŒ–è®¾è®¡ã€æ¥å£æŠ½è±¡ã€é”™è¯¯å¤„ç†ç­‰è½¯ä»¶å·¥ç¨‹æ ¸å¿ƒæŠ€èƒ½ï¼Œè¿™äº›èƒ½åŠ›å¯¹å¼€å‘è€…çš„é•¿æœŸæˆé•¿å…·æœ‰é‡è¦ä»·å€¼ã€‚

#### 3. å®šåˆ¶åŒ–éœ€æ±‚ä¸æ·±åº¦æŒæ¡çš„å¿…è¦æ€§

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸åŒåœºæ™¯å¯¹æ™ºèƒ½ä½“çš„éœ€æ±‚å·®å¼‚å·¨å¤§ï¼Œå¾€å¾€éƒ½éœ€è¦åœ¨é€šç”¨æ¡†æ¶åŸºç¡€ä¸ŠåšäºŒæ¬¡å¼€å‘ã€‚

- **ç‰¹å®šé¢†åŸŸçš„ä¼˜åŒ–éœ€æ±‚**ï¼šé‡‘èã€åŒ»ç–—ã€æ•™è‚²ç­‰å‚ç›´é¢†åŸŸå¾€å¾€éœ€è¦é’ˆå¯¹æ€§çš„æç¤ºè¯æ¨¡æ¿ã€ç‰¹æ®Šçš„å·¥å…·é›†æˆã€ä»¥åŠå®šåˆ¶åŒ–çš„å®‰å…¨ç­–ç•¥ã€‚

- **æ€§èƒ½ä¸èµ„æºçš„ç²¾ç¡®æ§åˆ¶**ï¼šç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹å“åº”æ—¶é—´ã€å†…å­˜å ç”¨ã€å¹¶å‘å¤„ç†èƒ½åŠ›éƒ½æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œé€šç”¨æ¡†æ¶çš„"ä¸€åˆ€åˆ‡"æ–¹æ¡ˆå¾€å¾€æ— æ³•æ»¡è¶³ç²¾ç»†åŒ–éœ€æ±‚ã€‚

- **å­¦ä¹ ä¸æ•™å­¦çš„é€æ˜æ€§è¦æ±‚**ï¼šåœ¨æˆ‘ä»¬çš„æ•™å­¦åœºæ™¯ä¸­ï¼Œå­¦ä¹ è€…æ›´æœŸå¾…çš„æ˜¯æ¸…æ™°åœ°çœ‹åˆ°æ™ºèƒ½ä½“çš„æ¯ä¸€æ­¥æ„å»ºè¿‡ç¨‹ï¼Œç†è§£ä¸åŒèŒƒå¼çš„å·¥ä½œæœºåˆ¶ï¼Œè¿™è¦æ±‚æ¡†æ¶å…·æœ‰é«˜åº¦çš„å¯è§‚æµ‹æ€§å’Œå¯è§£é‡Šæ€§ã€‚

### æ ¸å¿ƒå­¦ä¹ å†…å®¹

```
hello-agents/
â”œâ”€â”€ hello_agents/
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¡†æ¶å±‚
â”‚   â”‚   â”œâ”€â”€ agent.py              # AgentåŸºç±»
â”‚   â”‚   â”œâ”€â”€ llm.py                # HelloAgentsLLMç»Ÿä¸€æ¥å£
â”‚   â”‚   â”œâ”€â”€ message.py            # æ¶ˆæ¯ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ exceptions.py         # å¼‚å¸¸ä½“ç³»
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/                   # Agentå®ç°å±‚
â”‚   â”‚   â”œâ”€â”€ simple_agent.py       # SimpleAgentå®ç°
â”‚   â”‚   â”œâ”€â”€ react_agent.py        # ReActAgentå®ç°
â”‚   â”‚   â”œâ”€â”€ reflection_agent.py   # ReflectionAgentå®ç°
â”‚   â”‚   â””â”€â”€ plan_solve_agent.py   # PlanAndSolveAgentå®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                    # å·¥å…·ç³»ç»Ÿå±‚
â”‚   â”‚   â”œâ”€â”€ base.py               # å·¥å…·åŸºç±»
â”‚   â”‚   â”œâ”€â”€ registry.py           # å·¥å…·æ³¨å†Œæœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ chain.py              # å·¥å…·é“¾ç®¡ç†ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ async_executor.py     # å¼‚æ­¥å·¥å…·æ‰§è¡Œå™¨
â”‚   â”‚   â””â”€â”€ builtin/              # å†…ç½®å·¥å…·é›†
â”‚   â”‚       â”œâ”€â”€ calculator.py     # è®¡ç®—å·¥å…·
â”‚   â”‚       â””â”€â”€ search.py         # æœç´¢å·¥å…·
â””â”€â”€
```

# ä»HelloAgentLLMå‡ºå‘

## æ”¯æŒå¤šæä¾›å•†

æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ HelloAgentsLLM ç±»ï¼Œå·²ç»èƒ½å¤Ÿé€šè¿‡ api_key å’Œ base_url è¿™ä¸¤ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œè¿æ¥ä»»ä½•å…¼å®¹ OpenAI æ¥å£çš„æœåŠ¡ã€‚è¿™åœ¨ç†è®ºä¸Šä¿è¯äº†é€šç”¨æ€§ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸åŒçš„æœåŠ¡å•†åœ¨ç¯å¢ƒå˜é‡å‘½åã€é»˜è®¤ API åœ°å€å’Œæ¨èæ¨¡å‹ç­‰æ–¹é¢éƒ½å­˜åœ¨å·®å¼‚ã€‚å¦‚æœæ¯æ¬¡åˆ‡æ¢æœåŠ¡å•†éƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æŸ¥è¯¢å¹¶ä¿®æ”¹ä»£ç ï¼Œä¼šæå¤§å½±å“å¼€å‘æ•ˆç‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥ provider.å…¶æ”¹è¿›æ€è·¯æ˜¯ï¼šè®© HelloAgentsLLM åœ¨å†…éƒ¨å¤„ç†ä¸åŒæœåŠ¡å•†çš„é…ç½®ç»†èŠ‚ï¼Œä»è€Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç»Ÿä¸€ã€ç®€æ´çš„è°ƒç”¨ä½“éªŒã€‚


### è‡ªä¸»æ£€æµ‹æœºåˆ¶

`_auto_detect_provider` æ–¹æ³•è´Ÿè´£æ ¹æ®ç¯å¢ƒä¿¡æ¯ï¼ŒæŒ‰ç…§ä¸‹è¿°ä¼˜å…ˆçº§é¡ºåºï¼Œå°è¯•è‡ªåŠ¨æ¨æ–­æœåŠ¡å•†ï¼š

#### 1. æœ€é«˜ä¼˜å…ˆçº§ï¼šæ£€æŸ¥ç‰¹å®šæœåŠ¡å•†çš„ç¯å¢ƒå˜é‡

è¿™æ˜¯æœ€ç›´æ¥ã€æœ€å¯é çš„åˆ¤æ–­ä¾æ®ã€‚æ¡†æ¶ä¼šä¾æ¬¡æ£€æŸ¥ä»¥ä¸‹ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼š
- `MODELSCOPE_API_KEY`
- `OPENAI_API_KEY`
- `ZHIPU_API_KEY`
- `DEEPSEEK_API_KEY`
- `DASHSCOPE_API_KEY`
- ç­‰å…¶ä»–ç‰¹å®šæœåŠ¡å•†çš„ç¯å¢ƒå˜é‡

ä¸€æ—¦å‘ç°ä»»ä½•ä¸€ä¸ªï¼Œå°±ä¼šç«‹å³ç¡®å®šå¯¹åº”çš„æœåŠ¡å•†ã€‚

#### 2. æ¬¡é«˜ä¼˜å…ˆçº§ï¼šæ ¹æ® base_url è¿›è¡Œåˆ¤æ–­

å¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®ç‰¹å®šæœåŠ¡å•†çš„å¯†é’¥ï¼Œä½†è®¾ç½®äº†é€šç”¨çš„ `LLM_BASE_URL`ï¼Œæ¡†æ¶ä¼šè½¬è€Œè§£æè¿™ä¸ª URLï¼š

- **åŸŸååŒ¹é…**ï¼šé€šè¿‡æ£€æŸ¥ URL ä¸­æ˜¯å¦åŒ…å«ä»¥ä¸‹ç‰¹å¾å­—ç¬¦ä¸²æ¥è¯†åˆ«äº‘æœåŠ¡å•†ï¼š
  - `api-inference.modelscope.cn` â†’ ModelScope
  - `api.openai.com` â†’ OpenAI
  - `api.deepseek.com` â†’ DeepSeek
  - `dashscope.aliyuncs.com` â†’ é€šä¹‰åƒé—®
  - `api.moonshot.cn` â†’ Kimi
  - `open.bigmodel.cn` â†’ æ™ºè°±AI

- **ç«¯å£åŒ¹é…**ï¼šé€šè¿‡æ£€æŸ¥ URL ä¸­æ˜¯å¦åŒ…å«ä»¥ä¸‹æ ‡å‡†ç«¯å£æ¥è¯†åˆ«æœ¬åœ°éƒ¨ç½²æ–¹æ¡ˆï¼š
  - `:11434` â†’ Ollama
  - `:8000` â†’ VLLM
  - `:8080` æˆ– `:7860` â†’ å…¶ä»–æœ¬åœ°æœåŠ¡

#### 3. è¾…åŠ©åˆ¤æ–­ï¼šåˆ†æ API å¯†é’¥çš„æ ¼å¼

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœä¸Šè¿°ä¸¤ç§æ–¹å¼éƒ½æ— æ³•ç¡®å®šï¼Œæ¡†æ¶ä¼šå°è¯•åˆ†æé€šç”¨ç¯å¢ƒå˜é‡ `LLM_API_KEY` çš„æ ¼å¼ï¼š

- æŸäº›æœåŠ¡å•†çš„ API å¯†é’¥æœ‰å›ºå®šçš„å‰ç¼€æˆ–ç‹¬ç‰¹çš„ç¼–ç æ ¼å¼
- ä¾‹å¦‚ï¼šä»¥ `ms-` å¼€å¤´çš„å¯†é’¥é€šå¸¸å±äº ModelScope
- ç”±äºè¿™ç§æ–¹å¼å¯èƒ½å­˜åœ¨æ¨¡ç³Šæ€§ï¼ˆä¾‹å¦‚å¤šä¸ªæœåŠ¡å•†çš„å¯†é’¥æ ¼å¼ç›¸ä¼¼ï¼‰ï¼Œå› æ­¤å®ƒçš„ä¼˜å…ˆçº§è¾ƒä½ï¼Œä»…ä½œä¸ºè¾…åŠ©æ‰‹æ®µ

å…¶éƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹ï¼š
```python
    def _auto_detect_provider(self, api_key: Optional[str], base_url: Optional[str]) -> str:
        """
        è‡ªåŠ¨æ£€æµ‹LLMæä¾›å•†

        æ£€æµ‹é€»è¾‘ï¼š
        1. ä¼˜å…ˆæ£€æŸ¥ç‰¹å®šæä¾›å•†çš„ç¯å¢ƒå˜é‡
        2. æ ¹æ®APIå¯†é’¥æ ¼å¼åˆ¤æ–­
        3. æ ¹æ®base_urlåˆ¤æ–­
        4. é»˜è®¤è¿”å›é€šç”¨é…ç½®
        """
        # 1. æ£€æŸ¥ç‰¹å®šæä¾›å•†çš„ç¯å¢ƒå˜é‡ (æœ€é«˜ä¼˜å…ˆçº§)
        if os.getenv("MODELSCOPE_API_KEY"): return "modelscope"
        if os.getenv("OPENAI_API_KEY"): return "openai"
        if os.getenv("ZHIPU_API_KEY"): return "zhipu"
        # ... å…¶ä»–æœåŠ¡å•†çš„ç¯å¢ƒå˜é‡æ£€æŸ¥

        # è·å–é€šç”¨çš„ç¯å¢ƒå˜é‡
        actual_api_key = api_key or os.getenv("LLM_API_KEY")
        actual_base_url = base_url or os.getenv("LLM_BASE_URL")

        # 2. æ ¹æ® base_url åˆ¤æ–­
        if actual_base_url:
            base_url_lower = actual_base_url.lower()
            if "api-inference.modelscope.cn" in base_url_lower: return "modelscope"
            if "open.bigmodel.cn" in base_url_lower: return "zhipu"
            if "localhost" in base_url_lower or "127.0.0.1" in base_url_lower:
                if ":11434" in base_url_lower: return "ollama"
                if ":8000" in base_url_lower: return "vllm"
                return "local" # å…¶ä»–æœ¬åœ°ç«¯å£

        # 3. æ ¹æ® API å¯†é’¥æ ¼å¼è¾…åŠ©åˆ¤æ–­
        if actual_api_key:
            if actual_api_key.startswith("ms-"): return "modelscope"
            # ... å…¶ä»–å¯†é’¥æ ¼å¼åˆ¤æ–­

        # 4. é»˜è®¤è¿”å› 'auto'ï¼Œä½¿ç”¨é€šç”¨é…ç½®
        return "auto"
```

### å‡­è¯è§£ææœºåˆ¶

ä¸€æ—¦ `provider` è¢«ç¡®å®šï¼ˆæ— è®ºæ˜¯ç”¨æˆ·æŒ‡å®šè¿˜æ˜¯è‡ªåŠ¨æ£€æµ‹ï¼‰ï¼Œ`_resolve_credentials` æ–¹æ³•ä¾¿ä¼šæ¥æ‰‹å¤„ç†æœåŠ¡å•†çš„å·®å¼‚åŒ–é…ç½®ã€‚

è¯¥æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š

1. **æ ¹æ® provider æŸ¥æ‰¾å¯¹åº”çš„ç¯å¢ƒå˜é‡**ï¼šæ¯ä¸ªæœåŠ¡å•†éƒ½æœ‰å…¶ç‰¹å®šçš„ç¯å¢ƒå˜é‡åç§°ï¼ˆå¦‚ `OPENAI_API_KEY`ã€`MODELSCOPE_API_KEY` ç­‰ï¼‰
2. **è®¾ç½®é»˜è®¤çš„ base_url**ï¼šå¦‚æœç”¨æˆ·æœªæä¾› `base_url`ï¼Œæ¡†æ¶ä¼šæ ¹æ® `provider` è‡ªåŠ¨è®¾ç½®å¯¹åº”çš„é»˜è®¤åœ°å€
3. **ä¼˜å…ˆçº§å¤„ç†**ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ï¼Œå…¶æ¬¡ä½¿ç”¨ç‰¹å®šæœåŠ¡å•†çš„ç¯å¢ƒå˜é‡ï¼Œæœ€åä½¿ç”¨é€šç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼

å…¶éƒ¨åˆ†å…³é”®å®ç°å¦‚ä¸‹ï¼š

```python
def _resolve_credentials(self, api_key: Optional[str], base_url: Optional[str]) -> tuple[str, str]:
    """æ ¹æ®providerè§£æAPIå¯†é’¥å’Œbase_url"""
    if self.provider == "openai":
        resolved_api_key = api_key or os.getenv("OPENAI_API_KEY") or os.getenv("LLM_API_KEY")
        resolved_base_url = base_url or os.getenv("LLM_BASE_URL") or "https://api.openai.com/v1"
        return resolved_api_key, resolved_base_url

    elif self.provider == "modelscope":
        resolved_api_key = api_key or os.getenv("MODELSCOPE_API_KEY") or os.getenv("LLM_API_KEY")
        resolved_base_url = base_url or os.getenv("LLM_BASE_URL") or "https://api-inference.modelscope.cn/v1/"
        return resolved_api_key, resolved_base_url
    
    # ... å…¶ä»–æœåŠ¡å•†çš„é€»è¾‘
```

# æ¡†æ¶æ¥å£å®ç°

åœ¨ä¸ŠèŠ‚ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº† `HelloAgentsLLM` è¿™ä¸€æ ¸å¿ƒç»„ä»¶ï¼Œè§£å†³äº†ä¸å¤§è¯­è¨€æ¨¡å‹é€šä¿¡çš„å…³é”®é—®é¢˜ã€‚ä¸è¿‡å®ƒè¿˜éœ€è¦ä¸€ç³»åˆ—é…å¥—çš„æ¥å£å’Œç»„ä»¶æ¥å¤„ç†æ•°æ®æµã€ç®¡ç†é…ç½®ã€åº”å¯¹å¼‚å¸¸ï¼Œå¹¶ä¸ºä¸Šå±‚åº”ç”¨çš„æ„å»ºæä¾›ä¸€ä¸ªæ¸…æ™°ã€ç»Ÿä¸€çš„ç»“æ„ã€‚

æœ¬èŠ‚å°†è®²è¿°ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼š

- **`message.py`**ï¼šå®šä¹‰äº†æ¡†æ¶å†…ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ï¼Œç¡®ä¿äº†æ™ºèƒ½ä½“ä¸æ¨¡å‹ä¹‹é—´ä¿¡æ¯ä¼ é€’çš„æ ‡å‡†åŒ–ã€‚

- **`config.py`**ï¼šæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œä½¿æ¡†æ¶çš„è¡Œä¸ºæ˜“äºè°ƒæ•´å’Œæ‰©å±•ã€‚

- **`agent.py`**ï¼šå®šä¹‰äº†æ‰€æœ‰æ™ºèƒ½ä½“çš„æŠ½è±¡åŸºç±»ï¼ˆ`Agent`ï¼‰ï¼Œä¸ºåç»­å®ç°ä¸åŒç±»å‹çš„æ™ºèƒ½ä½“æä¾›äº†ç»Ÿä¸€çš„æ¥å£å’Œè§„èŒƒã€‚

## Messageç±»

åœ¨æ™ºèƒ½ä½“ä¸å¤§è¯­è¨€æ¨¡å‹çš„äº¤äº’ä¸­ï¼Œå¯¹è¯å†å²æ˜¯è‡³å…³é‡è¦çš„ä¸Šä¸‹æ–‡ã€‚
ä¸ºäº†è§„èŒƒåœ°ç®¡ç†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªç®€æ˜“ Message ç±»ã€‚åœ¨åç»­ä¸Šä¸‹æ–‡å·¥ç¨‹ç« èŠ‚ä¸­ï¼Œä¼šå¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚

## Configç±»

Config ç±»çš„èŒè´£æ˜¯å°†ä»£ç ä¸­ç¡¬ç¼–ç é…ç½®å‚æ•°é›†ä¸­èµ·æ¥ï¼Œå¹¶æ”¯æŒä»ç¯å¢ƒå˜é‡ä¸­è¯»å–ã€‚

## AgentæŠ½è±¡åŸºç±»

Agent ç±»æ˜¯æ•´ä¸ªæ¡†æ¶çš„é¡¶å±‚æŠ½è±¡ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ™ºèƒ½ä½“åº”è¯¥å…·å¤‡çš„é€šç”¨è¡Œä¸ºå’Œå±æ€§ï¼Œä½†å¹¶ä¸å…³å¿ƒå…·ä½“çš„å®ç°æ–¹å¼ã€‚
æˆ‘ä»¬é€šè¿‡ Python çš„ abc (Abstract Base Classes) æ¨¡å—æ¥å®ç°å®ƒï¼Œè¿™å¼ºåˆ¶æ‰€æœ‰å…·ä½“çš„æ™ºèƒ½ä½“å®ç°ï¼ˆå¦‚åç»­ç« èŠ‚çš„ SimpleAgent, ReActAgent ç­‰ï¼‰éƒ½å¿…é¡»éµå¾ªåŒä¸€ä¸ªâ€œæ¥å£â€ã€‚

è¯¥ç±»çš„è®¾è®¡ä½“ç°äº†é¢å‘å¯¹è±¡ä¸­çš„æŠ½è±¡åŸåˆ™ã€‚é¦–å…ˆï¼Œå®ƒé€šè¿‡ç»§æ‰¿ ABC è¢«å®šä¹‰ä¸ºä¸€ä¸ªä¸èƒ½ç›´æ¥å®ä¾‹åŒ–çš„æŠ½è±¡ç±»ã€‚å…¶æ„é€ å‡½æ•° __init__ æ¸…æ™°åœ°å®šä¹‰äº† Agent çš„æ ¸å¿ƒä¾èµ–ï¼šåç§°ã€LLM å®ä¾‹ã€ç³»ç»Ÿæç¤ºè¯å’Œé…ç½®ã€‚æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ä½¿ç”¨ @abstractmethod è£…é¥°çš„ run æ–¹æ³•ï¼Œå®ƒå¼ºåˆ¶æ‰€æœ‰å­ç±»å¿…é¡»å®ç°æ­¤æ–¹æ³•ï¼Œä»è€Œä¿è¯äº†æ‰€æœ‰æ™ºèƒ½ä½“éƒ½æœ‰ç»Ÿä¸€çš„æ‰§è¡Œå…¥å£ã€‚æ­¤å¤–ï¼ŒåŸºç±»è¿˜æä¾›äº†é€šç”¨çš„å†å²è®°å½•ç®¡ç†æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ Message ç±»ååŒå·¥ä½œï¼Œä½“ç°äº†ç»„ä»¶é—´çš„è”ç³»ã€‚


# AgentèŒƒå¼çš„æ¡†æ¶åå®ç°

## SimpleAgentæ¡†æ¶å®ç°

å…·ä½“å¼€å‘è¿‡ç¨‹è§æ–‡ä»¶ `` Chapter5/SimpleAgent `` 

# å·¥å…·ç³»ç»Ÿ

æœ¬èŠ‚å†…å®¹å°†åœ¨å‰é¢æ„å»ºçš„ Agent åŸºç¡€æ¶æ„ä¸Šï¼Œæ·±å…¥æ¢è®¨å·¥å…·ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ã€‚æˆ‘ä»¬å°†ä»åŸºç¡€è®¾æ–½å»ºè®¾å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°è‡ªå®šä¹‰å¼€å‘è®¾è®¡ã€‚

## å­¦ä¹ ç›®æ ‡

æœ¬èŠ‚çš„å­¦ä¹ ç›®æ ‡å›´ç»•ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ–¹é¢å±•å¼€ï¼š

- **ç»Ÿä¸€çš„å·¥å…·æŠ½è±¡ä¸ç®¡ç†**ï¼šå»ºç«‹æ ‡å‡†åŒ–çš„ `Tool` åŸºç±»å’Œ `ToolRegistry` æ³¨å†Œæœºåˆ¶ï¼Œä¸ºå·¥å…·çš„å¼€å‘ã€æ³¨å†Œã€å‘ç°å’Œæ‰§è¡Œæä¾›ç»Ÿä¸€çš„åŸºç¡€è®¾æ–½ã€‚

- **å®æˆ˜é©±åŠ¨çš„å·¥å…·å¼€å‘**ï¼šä»¥æ•°å­¦è®¡ç®—å·¥å…·ä¸ºæ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•è®¾è®¡å’Œå®ç°è‡ªå®šä¹‰å·¥å…·ï¼Œè®©è¯»è€…æŒæ¡å·¥å…·å¼€å‘çš„å®Œæ•´æµç¨‹ã€‚

- **é«˜çº§æ•´åˆä¸ä¼˜åŒ–ç­–ç•¥**ï¼šé€šè¿‡å¤šæºæœç´¢å·¥å…·çš„è®¾è®¡ï¼Œå±•ç¤ºå¦‚ä½•æ•´åˆå¤šä¸ªå¤–éƒ¨æœåŠ¡ï¼Œå®ç°æ™ºèƒ½åç«¯é€‰æ‹©ã€ç»“æœåˆå¹¶å’Œå®¹é”™å¤„ç†ï¼Œä½“ç°å·¥å…·ç³»ç»Ÿåœ¨å¤æ‚åœºæ™¯ä¸‹çš„è®¾è®¡æ€ç»´ã€‚

## å·¥å…·åŸºç±»ä¸æ³¨å†Œæœºåˆ¶è®¾è®¡

åœ¨æ„å»ºå¯æ‰©å±•çš„å·¥å…·ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå»ºç«‹ä¸€å¥—æ ‡å‡†åŒ–çš„åŸºç¡€è®¾æ–½ã€‚è¿™å¥—åŸºç¡€è®¾æ–½åŒ…æ‹¬ `Tool` åŸºç±»ã€`ToolRegistry` æ³¨å†Œè¡¨ï¼Œä»¥åŠå·¥å…·ç®¡ç†æœºåˆ¶ã€‚

### 1. Tool åŸºç±»çš„æŠ½è±¡è®¾è®¡

`Tool` åŸºç±»æ˜¯æ•´ä¸ªå·¥å…·ç³»ç»Ÿçš„æ ¸å¿ƒæŠ½è±¡ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰å·¥å…·å¿…é¡»éµå¾ªçš„æ¥å£è§„èŒƒï¼š

```python
class Tool(ABC):
    """å·¥å…·åŸºç±»"""

    def __init__(self, name: str, description: str):
        self.name = name
        self.description = description

    @abstractmethod
    def run(self, parameters: Dict[str, Any]) -> str:
        """æ‰§è¡Œå·¥å…·"""
        pass

    @abstractmethod
    def get_parameters(self) -> List[ToolParameter]:
        """è·å–å·¥å…·å‚æ•°å®šä¹‰"""
        pass
```

è¿™ä¸ªè®¾è®¡ä½“ç°äº†é¢å‘å¯¹è±¡è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³ï¼š

- **ç»Ÿä¸€çš„æ‰§è¡Œæ¥å£**ï¼šé€šè¿‡ç»Ÿä¸€çš„ `run` æ–¹æ³•æ¥å£ï¼Œæ‰€æœ‰å·¥å…·éƒ½èƒ½ä»¥ä¸€è‡´çš„æ–¹å¼æ‰§è¡Œï¼Œæ¥å—å­—å…¸å‚æ•°å¹¶è¿”å›å­—ç¬¦ä¸²ç»“æœï¼Œç¡®ä¿äº†æ¡†æ¶çš„ä¸€è‡´æ€§ã€‚

- **è‡ªæè¿°èƒ½åŠ›**ï¼šé€šè¿‡ `get_parameters` æ–¹æ³•èƒ½å¤Ÿæ¸…æ™°åœ°å‘Šè¯‰è°ƒç”¨è€…è‡ªå·±éœ€è¦ä»€ä¹ˆå‚æ•°ï¼Œè¿™ç§å†…çœæœºåˆ¶ä¸ºè‡ªåŠ¨åŒ–æ–‡æ¡£ç”Ÿæˆå’Œå‚æ•°éªŒè¯æä¾›äº†åŸºç¡€ã€‚

- **å¯å‘ç°æ€§**ï¼š`name` å’Œ `description` ç­‰å…ƒæ•°æ®çš„è®¾è®¡ï¼Œè®©å·¥å…·ç³»ç»Ÿå…·å¤‡äº†è‰¯å¥½çš„å¯å‘ç°æ€§å’Œå¯ç†è§£æ€§ã€‚

### 2. ToolParameter å‚æ•°å®šä¹‰ç³»ç»Ÿ

ä¸ºäº†æ”¯æŒå¤æ‚çš„å‚æ•°éªŒè¯å’Œæ–‡æ¡£ç”Ÿæˆï¼Œæˆ‘ä»¬è®¾è®¡äº† `ToolParameter` ç±»ï¼š

```python
class ToolParameter(BaseModel):
    """å·¥å…·å‚æ•°å®šä¹‰"""
    name: str
    type: str
    description: str
    required: bool = True
    default: Any = None
```

è¿™ç§è®¾è®¡è®©å·¥å…·èƒ½å¤Ÿç²¾ç¡®æè¿°è‡ªå·±çš„å‚æ•°éœ€æ±‚ï¼Œæ”¯æŒï¼š
- ç±»å‹æ£€æŸ¥
- é»˜è®¤å€¼è®¾ç½®
- æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

### 3. ToolRegistry æ³¨å†Œè¡¨çš„å®ç°

`ToolRegistry` æ˜¯å·¥å…·ç³»ç»Ÿçš„ç®¡ç†ä¸­æ¢ï¼Œå®ƒæä¾›äº†å·¥å…·çš„æ³¨å†Œã€å‘ç°ã€æ‰§è¡Œç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚åœ¨è¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦ç”¨åˆ°ä»¥ä¸‹åŠŸèƒ½ï¼š

```python
class ToolRegistry:
    """HelloAgentså·¥å…·æ³¨å†Œè¡¨"""

    def __init__(self):
        self._tools: dict[str, Tool] = {}
        self._functions: dict[str, dict[str, Any]] = {}

    def register_tool(self, tool: Tool):
        """æ³¨å†ŒToolå¯¹è±¡"""
        if tool.name in self._tools:
            print(f"âš ï¸ è­¦å‘Š:å·¥å…· '{tool.name}' å·²å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–ã€‚")
        self._tools[tool.name] = tool
        print(f"âœ… å·¥å…· '{tool.name}' å·²æ³¨å†Œã€‚")
        
    def register_function(self, name: str, description: str, func: Callable[[str], str]):
        """
        ç›´æ¥æ³¨å†Œå‡½æ•°ä½œä¸ºå·¥å…·ï¼ˆç®€ä¾¿æ–¹å¼ï¼‰

        Args:
            name: å·¥å…·åç§°
            description: å·¥å…·æè¿°
            func: å·¥å…·å‡½æ•°ï¼Œæ¥å—å­—ç¬¦ä¸²å‚æ•°ï¼Œè¿”å›å­—ç¬¦ä¸²ç»“æœ
        """
        if name in self._functions:
            print(f"âš ï¸ è­¦å‘Š:å·¥å…· '{name}' å·²å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–ã€‚")

        self._functions[name] = {
            "description": description,
            "func": func
        }
        print(f"âœ… å·¥å…· '{name}' å·²æ³¨å†Œã€‚")
```

`ToolRegistry` æ”¯æŒä¸¤ç§æ³¨å†Œæ–¹å¼ï¼š

- **Tool å¯¹è±¡æ³¨å†Œ**ï¼šé€‚åˆå¤æ‚å·¥å…·ï¼Œæ”¯æŒå®Œæ•´çš„å‚æ•°å®šä¹‰å’ŒéªŒè¯
- **å‡½æ•°ç›´æ¥æ³¨å†Œ**ï¼šé€‚åˆç®€å•å·¥å…·ï¼Œå¿«é€Ÿé›†æˆç°æœ‰å‡½æ•°

### 4. å·¥å…·å‘ç°ä¸ç®¡ç†æœºåˆ¶

æ³¨å†Œè¡¨æä¾›äº†ä¸°å¯Œçš„å·¥å…·ç®¡ç†åŠŸèƒ½ï¼š

#### è·å–å·¥å…·æè¿°

```python
def get_tools_description(self) -> str:
    """è·å–æ‰€æœ‰å¯ç”¨å·¥å…·çš„æ ¼å¼åŒ–æè¿°å­—ç¬¦ä¸²"""
    descriptions = []

    # Toolå¯¹è±¡æè¿°
    for tool in self._tools.values():
        descriptions.append(f"- {tool.name}: {tool.description}")

    # å‡½æ•°å·¥å…·æè¿°
    for name, info in self._functions.items():
        descriptions.append(f"- {name}: {info['description']}")

    return "\n".join(descriptions) if descriptions else "æš‚æ— å¯ç”¨å·¥å…·"
```

è¿™ä¸ªæ–¹æ³•ç”Ÿæˆçš„æè¿°å­—ç¬¦ä¸²å¯ä»¥ç›´æ¥ç”¨äºæ„å»º Agent çš„æç¤ºè¯ï¼Œè®© Agent äº†è§£å¯ç”¨çš„å·¥å…·ã€‚

#### è½¬æ¢ä¸º OpenAI Schema

```python
def to_openai_schema(self) -> Dict[str, Any]:
    """è½¬æ¢ä¸º OpenAI function calling schema æ ¼å¼

    ç”¨äº FunctionCallAgentï¼Œä½¿å·¥å…·èƒ½å¤Ÿè¢« OpenAI åŸç”Ÿ function calling ä½¿ç”¨

    Returns:
        ç¬¦åˆ OpenAI function calling æ ‡å‡†çš„ schema
    """
    parameters = self.get_parameters()

    # æ„å»º properties
    properties = {}
    required = []

    for param in parameters:
        # åŸºç¡€å±æ€§å®šä¹‰
        prop = {
            "type": param.type,
            "description": param.description
        }

        # å¦‚æœæœ‰é»˜è®¤å€¼ï¼Œæ·»åŠ åˆ°æè¿°ä¸­ï¼ˆOpenAI schema ä¸æ”¯æŒ default å­—æ®µï¼‰
        if param.default is not None:
            prop["description"] = f"{param.description} (é»˜è®¤: {param.default})"

        # å¦‚æœæ˜¯æ•°ç»„ç±»å‹ï¼Œæ·»åŠ  items å®šä¹‰
        if param.type == "array":
            prop["items"] = {"type": "string"}  # é»˜è®¤å­—ç¬¦ä¸²æ•°ç»„

        properties[param.name] = prop

        # æ”¶é›†å¿…éœ€å‚æ•°
        if param.required:
            required.append(param.name)

    return {
        "type": "function",
        "function": {
            "name": self.name,
            "description": self.description,
            "parameters": {
                "type": "object",
                "properties": properties,
                "required": required
            }
        }
    }
```

è¿™ä¸ªæ–¹æ³•ç”Ÿæˆçš„ schema å¯ä»¥ç›´æ¥ç”¨äºåŸç”Ÿçš„ OpenAI SDK çš„å·¥å…·è°ƒç”¨ã€‚

OpenAI Functioncall Schemaï¼š

```python
tools = [
  {
    "type": "function", #å·¥å…·ç±»å‹
    "function": {
      "name": "get_current_weather", #å‡½æ•°åç§°
      "description": "Get the current weather in a given location", #å‡½æ•°æè¿°
      "parameters": { #å‡½æ•°å‚æ•°
        "type": "object", #å‚æ•°ç±»å‹
        "properties": { #å‚æ•°å±æ€§
          "location": {"type": "string", "description": "The city and state, e.g. San Francisco, CA"}, #å‚æ•°åç§°å’Œæè¿°
          "unit": {"type": "string", "enum": ["celsius", "fahrenheit"]}, #å‚æ•°æšä¸¾å€¼
        },
        "required": ["location"], #å‚æ•°å¿…å¡«
      },
    }
  }
]
```

## è‡ªå®šä¹‰å·¥å…·å¼€å‘

æœ‰äº†åŸºç¡€è®¾æ–½åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å¼€å‘ä¸€ä¸ªå®Œæ•´çš„è‡ªå®šä¹‰å·¥å…·ã€‚æ•°å­¦è®¡ç®—å·¥å…·æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå› ä¸ºå®ƒç®€å•ç›´è§‚ï¼Œæœ€ç›´æ¥çš„æ–¹å¼æ˜¯ä½¿ç”¨ToolRegistryçš„å‡½æ•°æ³¨å†ŒåŠŸèƒ½ã€‚

å…·ä½“çœ‹ ``Chapter5/tool``

## å¤šæºæœç´¢å·¥å…·

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æ•´åˆå¤šä¸ªå¤–éƒ¨æœåŠ¡æ¥æä¾›æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚æœç´¢å·¥å…·å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå®ƒæ•´åˆå¤šä¸ªæœç´¢å¼•æ“ï¼Œèƒ½æä¾›æ›´åŠ å®Œå¤‡çš„çœŸå®ä¿¡æ¯ã€‚åœ¨ç¬¬ä¸€ç« æˆ‘ä»¬ä½¿ç”¨è¿‡ Tavily çš„æœç´¢ APIï¼Œåœ¨ç¬¬å››ç« æˆ‘ä»¬ä½¿ç”¨è¿‡ SerpApi çš„æœç´¢ APIã€‚

### 1. æœç´¢å·¥å…·çš„ç»Ÿä¸€æ¥å£è®¾è®¡

HelloAgents æ¡†æ¶å†…ç½®çš„ `SearchTool` å±•ç¤ºäº†å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜çº§çš„å¤šæºæœç´¢å·¥å…·ï¼š

```python
class SearchTool(Tool):
    """
    æ™ºèƒ½æ··åˆæœç´¢å·¥å…·

    æ”¯æŒå¤šç§æœç´¢å¼•æ“åç«¯ï¼Œæ™ºèƒ½é€‰æ‹©æœ€ä½³æœç´¢æº:
    1. æ··åˆæ¨¡å¼ (hybrid) - æ™ºèƒ½é€‰æ‹©TAVILYæˆ–SERPAPI
    2. Tavily API (tavily) - ä¸“ä¸šAIæœç´¢
    3. SerpApi (serpapi) - ä¼ ç»ŸGoogleæœç´¢
    """

    def __init__(self, backend: str = "hybrid", tavily_key: Optional[str] = None, serpapi_key: Optional[str] = None):
        super().__init__(
            name="search",
            description="ä¸€ä¸ªæ™ºèƒ½ç½‘é¡µæœç´¢å¼•æ“ã€‚æ”¯æŒæ··åˆæœç´¢æ¨¡å¼ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³æœç´¢æºã€‚"
        )
        self.backend = backend
        self.tavily_key = tavily_key or os.getenv("TAVILY_API_KEY")
        self.serpapi_key = serpapi_key or os.getenv("SEARCH_API_KEY")
        self.available_backends = []      # 1. åˆå§‹åŒ–å¯ç”¨åç«¯åˆ—è¡¨
        self._setup_backends()            # 2. è®¾ç½®å’Œé…ç½®åç«¯

    def _setup_backends(self):
        """æ£€æµ‹å¹¶è®¾ç½®å¯ç”¨çš„æœç´¢åç«¯"""
        
        # æ£€æµ‹ Tavily åç«¯
        if self.tavily_key:
            try:
                import tavily_python
                self.available_backends.append("tavily")
                print("âœ… Tavily åç«¯å¯ç”¨")
            except ImportError:
                print("âš ï¸ Tavily åº“æœªå®‰è£…")
        
        # æ£€æµ‹ SerpApi åç«¯
        if self.serpapi_key:
            try:
                from serpapi import GoogleSearch
                self.available_backends.append("serpapi")
                print("âœ… SerpApi åç«¯å¯ç”¨")
            except ImportError:
                print("âš ï¸ SerpApi åº“æœªå®‰è£…")
        
        # å¦‚æœæ²¡æœ‰å¯ç”¨åç«¯ï¼ŒæŠ¥é”™
        if not self.available_backends:
            raise ValueError("æ²¡æœ‰å¯ç”¨çš„æœç´¢åç«¯ï¼Œè¯·é…ç½®è‡³å°‘ä¸€ä¸ª API å¯†é’¥")
```

è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒæ€æƒ³æ˜¯æ ¹æ®å¯ç”¨çš„ API å¯†é’¥å’Œä¾èµ–åº“ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³çš„æœç´¢åç«¯ã€‚

### 2. Tavily ä¸ SerpApi æœç´¢æºçš„æ•´åˆç­–ç•¥

æ¡†æ¶å®ç°äº†æ™ºèƒ½çš„åç«¯é€‰æ‹©é€»è¾‘ï¼Œé€šè¿‡é™çº§æœºåˆ¶ç¡®ä¿é«˜å¯ç”¨æ€§ï¼š

```python
def _search_hybrid(self, query: str) -> str:
    """æ··åˆæœç´¢ - æ™ºèƒ½é€‰æ‹©æœ€ä½³æœç´¢æº"""
    # ä¼˜å…ˆä½¿ç”¨Tavilyï¼ˆAIä¼˜åŒ–çš„æœç´¢ï¼‰
    if "tavily" in self.available_backends:
        try:
            return self._search_tavily(query)
        except Exception as e:
            print(f"âš ï¸ Tavilyæœç´¢å¤±è´¥: {e}")
            # å¦‚æœTavilyå¤±è´¥ï¼Œå°è¯•SerpApi
            if "serpapi" in self.available_backends:
                print("ğŸ”„ åˆ‡æ¢åˆ°SerpApiæœç´¢")
                return self._search_serpapi(query)

    # å¦‚æœTavilyä¸å¯ç”¨ï¼Œä½¿ç”¨SerpApi
    elif "serpapi" in self.available_backends:
        try:
            return self._search_serpapi(query)
        except Exception as e:
            print(f"âš ï¸ SerpApiæœç´¢å¤±è´¥: {e}")

    # å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œæç¤ºç”¨æˆ·é…ç½®API
    return "âŒ æ²¡æœ‰å¯ç”¨çš„æœç´¢æºï¼Œè¯·é…ç½®TAVILY_API_KEYæˆ–SERPAPI_API_KEYç¯å¢ƒå˜é‡"
```

**è®¾è®¡ä¼˜åŠ¿ï¼š**

- **é™çº§æœºåˆ¶**ï¼šä»æœ€ä¼˜çš„æœç´¢æºé€æ­¥é™çº§åˆ°å¯ç”¨çš„å¤‡é€‰æ–¹æ¡ˆ
- **å®¹é”™å¤„ç†**ï¼šå½“æŸä¸ªæœç´¢æºå¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆ
- **æ˜ç¡®æç¤º**ï¼šå½“æ‰€æœ‰æœç´¢æºéƒ½ä¸å¯ç”¨æ—¶ï¼Œæ˜ç¡®æç¤ºç”¨æˆ·é…ç½®æ­£ç¡®çš„ API å¯†é’¥

### 3. æœç´¢ç»“æœçš„ç»Ÿä¸€æ ¼å¼åŒ–

ä¸åŒæœç´¢å¼•æ“è¿”å›çš„ç»“æœæ ¼å¼ä¸åŒï¼Œæ¡†æ¶é€šè¿‡ç»Ÿä¸€çš„æ ¼å¼åŒ–æ–¹æ³•æ¥å¤„ç†ï¼š

```python
def _search_tavily(self, query: str) -> str:
    """ä½¿ç”¨Tavilyæœç´¢"""
    response = self.tavily_client.search(
        query=query,
        search_depth="basic",
        include_answer=True,
        max_results=3
    )

    result = f"ğŸ¯ Tavily AIæœç´¢ç»“æœ:{response.get('answer', 'æœªæ‰¾åˆ°ç›´æ¥ç­”æ¡ˆ')}\n\n"

    for i, item in enumerate(response.get('results', [])[:3], 1):
        result += f"[{i}] {item.get('title', '')}\n"
        result += f"    {item.get('content', '')[:200]}...\n"
        result += f"    æ¥æº: {item.get('url', '')}\n\n"

    return result
```

**æ ¼å¼åŒ–è¦ç‚¹ï¼š**

- **ç»Ÿä¸€è¾“å‡ºæ ¼å¼**ï¼šæ— è®ºä½¿ç”¨å“ªä¸ªæœç´¢åç«¯ï¼Œè¿”å›æ ¼å¼ä¿æŒä¸€è‡´
- **ç»“æ„åŒ–å±•ç¤º**ï¼šåŒ…å«æ ‡é¢˜ã€å†…å®¹æ‘˜è¦ã€æ¥æºé“¾æ¥ç­‰ä¿¡æ¯
- **å†…å®¹æˆªå–**ï¼šé™åˆ¶å†…å®¹é•¿åº¦ï¼Œé¿å…è¾“å‡ºè¿‡é•¿

åŸºäºæ¡†æ¶çš„è®¾è®¡æ€æƒ³ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„é«˜çº§æœç´¢å·¥å…·ã€‚
